
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>vocoder</title><meta name="generator" content="MATLAB 9.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2020-06-04"><meta name="DC.source" content="vocoder.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><pre class="codeinput"><span class="comment">% Austin Gilbert</span>
<span class="comment">% B EE 235 Spring 2020</span>
<span class="comment">% Final Project: N-Channel Vocoder</span>
<span class="comment">% vocoder.m</span>

<span class="keyword">function</span> y = vocoder(inputfile, outputfile, bandnum, soundon, graphon, noiseon)
<span class="comment">% This N-Channel Vocoder modulates a signal into Vocoded Speech</span>
<span class="comment">%   inputfile - the signal to modulate with the carrier signal</span>
<span class="comment">%   outputfile - file name to use for output</span>
<span class="comment">%   bandnum - number of bands/channels</span>
<span class="comment">%   soundon - the boolean to play sound</span>
<span class="comment">%   graphon - the boolean to create figures</span>
<span class="comment">%   noiseon - the boolean to replace carrier signal with white noise</span>

<span class="comment">% Description</span>
disp([<span class="string">'Modulating '</span>,inputfile,<span class="string">' to '</span>,outputfile,<span class="string">' through a '</span>,num2str(bandnum),<span class="string">'-Band Vocoder.'</span>]);
f = waitbar(0, <span class="string">'Starting'</span>);

<span class="comment">% Boundary Frequency Generation for N Bands</span>
xmin = log10(300/165.4+1)/2.1;                  <span class="comment">% min log frequency</span>
xmax = log10(6000/165.4+1)/2.1;                 <span class="comment">% max log frequency</span>
x = xmin:(xmax-xmin)/bandnum:xmax;
fco = zeros(1,bandnum+1);                       <span class="comment">% skeleton of fco vector</span>
<span class="keyword">for</span> i = 1:bandnum+1
    fco(i) = 165.4*(10^(x(i)*2.1)-1);           <span class="comment">% create fco vector</span>
<span class="keyword">end</span>

<span class="comment">% Bandpass Filter</span>
[signal, Fs] = audioread(inputfile);            <span class="comment">% read inputfile</span>
t = (0:length(signal)-1)/Fs;                    <span class="comment">% time vector creation</span>
y = zeros(length(t), 1);
carrier = rand(size(t));                        <span class="comment">% noise creation</span>
waitbar(.33, f, <span class="string">'Modulating'</span>);
<span class="keyword">for</span> n = 1:length(fco)-1
    [bb, aa] = butter(3,[fco(n), fco(n+1)]/(Fs/2));
    <span class="keyword">if</span> graphon
        figure(1)                               <span class="comment">% GRAPH - Freq Plot</span>
        [H, F] = freqz(bb, aa, 256, Fs);
        plot(F, abs(H), <span class="string">'DisplayName'</span>, [<span class="string">'Band '</span>, num2str(n)]);
        xlabel(<span class="string">'Frequency (Hz)'</span>);
        ylabel(<span class="string">'|H|'</span>);
        legend;
        title(<span class="string">'Frequency Response (Bandpass)'</span>);
        hold <span class="string">on</span>;
    <span class="keyword">end</span>
    bpsignal = filter(bb, aa, signal);          <span class="comment">% bandpass filter</span>
    <span class="keyword">if</span> graphon
        figure(2)                               <span class="comment">% GRAPH - Bandpassed Signal</span>
        plot(t, bpsignal, <span class="string">'DisplayName'</span>, [<span class="string">'Band '</span>, num2str(n)]);
        xlabel(<span class="string">'Time (s)'</span>);
        ylabel(<span class="string">'Amplitude (normalized)'</span>);
        legend
        title(<span class="string">'Bandpassed Signals'</span>);
        hold <span class="string">on</span>;
    <span class="keyword">end</span>

<span class="comment">% Envelope Rectification</span>
    rectsignal = abs(bpsignal);                 <span class="comment">% full-wave rectification</span>
    [dd, cc] = butter(2, 400/(Fs/2));           <span class="comment">% lowpass filter</span>
    <span class="keyword">if</span> graphon
        waitbar(.67, f, <span class="string">'Graphing Intermediate Waveforms'</span>);
        figure(3)                               <span class="comment">% GRAPH - Freq Plot</span>
        [H, F] = freqz(dd, cc, 256, Fs);
        plot(F, abs(H), <span class="string">'DisplayName'</span>, [<span class="string">'Band '</span>, num2str(n)]);
        xlabel(<span class="string">'Frequency (Hz)'</span>);
        ylabel(<span class="string">'|H|'</span>);
        legend;
        title(<span class="string">'Frequency Response (Lowpass)'</span>);
        hold <span class="string">on</span>;
    <span class="keyword">end</span>
    envelope = filter(dd, cc, rectsignal);
    <span class="keyword">if</span> graphon
        figure(4)                               <span class="comment">% GRAPH - Extracted Envelopes</span>
        subplot(bandnum/2, 2, n)
        plot(t, envelope);
        xlabel(<span class="string">'Time (s)'</span>);
        ylabel(<span class="string">'Amplitude'</span>);
        title([<span class="string">'Envelope '</span>, num2str(n)]);
        hold <span class="string">on</span>;
    <span class="keyword">end</span>

<span class="comment">% Carrier Modulation / Summation</span>
    <span class="keyword">if</span> ~noiseon                                 <span class="comment">% modulation with carrier</span>
        carrier = sin(2*pi*round((fco(n) + fco(n+1))/2)*t);
        <span class="keyword">if</span> graphon
            figure(5)                           <span class="comment">% GRAPH - Modulated Signals</span>
            subplot(bandnum/2, 2, n)
            plot(t, envelope .* carrier');
            xlabel(<span class="string">'Time (s)'</span>);
            ylabel(<span class="string">'Amplitude'</span>);
            title([<span class="string">'Mod Signal '</span>, num2str(n)]);
            hold <span class="string">on</span>;

        <span class="keyword">end</span>
        y = y + (envelope .* carrier');         <span class="comment">% summation &amp; modulation</span>
    <span class="keyword">else</span>
        carriermod = envelope .* carrier';
        <span class="keyword">if</span> graphon
            figure(5)                           <span class="comment">% GRAPH - Modulated Signals</span>
            subplot(bandnum/2, 2, n)
            plot(t, filter(bb, aa, carriermod));
            xlabel(<span class="string">'Time (s)'</span>);
            ylabel(<span class="string">'Amplitude'</span>);
            title([<span class="string">'Mod Signal '</span>, num2str(n)]);
            hold <span class="string">on</span>;
        <span class="keyword">end</span>
        y = y + filter(bb, aa, carriermod);     <span class="comment">% summation &amp; bandpass</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
y = y * (max(abs(signal))/max(abs(y)));
audiowrite(outputfile, y, Fs);

<span class="keyword">if</span> graphon
    waitbar(.84, f, <span class="string">'Graphing Final Waveforms'</span>);

    figure(6)                                   <span class="comment">% GRAPH - Original/Modulated Waveforms</span>
    subplot(211)
    plot(t, y)
    xlabel(<span class="string">'Time (s)'</span>);
    ylabel(<span class="string">'Amplitude (normalized)'</span>);
    title(<span class="string">'Modulated Signal'</span>);
    subplot(212)
    plot(t, signal)
    xlabel(<span class="string">'Time (s)'</span>);
    ylabel(<span class="string">'Amplitude (normalized)'</span>);
    title(<span class="string">'Original Signal'</span>);

    figure(7)                                   <span class="comment">% GRAPH - Spectrograms</span>
    subplot(211)
    [s, x, a] = spectrogram(y, hamming(512) ,32, 1024, Fs);
    surf(a, x, 20*log10(abs(s)), <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
    colormap(jet); view(0,90);
    xlabel(<span class="string">'Time (s)'</span>);
    ylabel(<span class="string">'Frequency (Hz)'</span>);
    title(<span class="string">'Modulated Signal Spectrogram'</span>);
    subplot(212)
    [s, x, a] = spectrogram(signal, hamming(512) ,32, 1024, Fs);
    surf(a, x, 20*log10(abs(s)), <span class="string">'EdgeColor'</span>, <span class="string">'none'</span>);
    colormap(jet); view(0,90);
    xlabel(<span class="string">'Time (s)'</span>);
    ylabel(<span class="string">'Frequency (Hz)'</span>);
    title(<span class="string">'Original Signal Spectrogram'</span>);
<span class="keyword">end</span>

waitbar(1, f, <span class="string">'Finishing'</span>)
close(f)

<span class="keyword">if</span> soundon
    linelength = fprintf(<span class="string">'The Original Sound'</span>); <span class="comment">% SOUND - Original Sound</span>
    sound(signal, Fs)
    pause(2)
    fprintf(repmat(<span class="string">'\b'</span>,1,linelength))

    linelength = fprintf(<span class="string">'The Modulated Sound'</span>);<span class="comment">% SOUND - Modulated Sound</span>
    sound(y, Fs)
    pause(2)
    fprintf(repmat(<span class="string">'\b'</span>,1,linelength))
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><pre class="codeoutput error">Not enough input arguments.

Error in vocoder (line 16)
disp(['Modulating ',inputfile,' to ',outputfile,' through a ',num2str(bandnum),'-Band Vocoder.']);
</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2018b</a><br></p></div><!--
##### SOURCE BEGIN #####
% Austin Gilbert
% B EE 235 Spring 2020
% Final Project: N-Channel Vocoder
% vocoder.m

function y = vocoder(inputfile, outputfile, bandnum, soundon, graphon, noiseon)
% This N-Channel Vocoder modulates a signal into Vocoded Speech
%   inputfile - the signal to modulate with the carrier signal
%   outputfile - file name to use for output
%   bandnum - number of bands/channels
%   soundon - the boolean to play sound
%   graphon - the boolean to create figures
%   noiseon - the boolean to replace carrier signal with white noise

% Description
disp(['Modulating ',inputfile,' to ',outputfile,' through a ',num2str(bandnum),'-Band Vocoder.']);
f = waitbar(0, 'Starting');

% Boundary Frequency Generation for N Bands
xmin = log10(300/165.4+1)/2.1;                  % min log frequency
xmax = log10(6000/165.4+1)/2.1;                 % max log frequency
x = xmin:(xmax-xmin)/bandnum:xmax;
fco = zeros(1,bandnum+1);                       % skeleton of fco vector
for i = 1:bandnum+1
    fco(i) = 165.4*(10^(x(i)*2.1)-1);           % create fco vector
end

% Bandpass Filter
[signal, Fs] = audioread(inputfile);            % read inputfile
t = (0:length(signal)-1)/Fs;                    % time vector creation
y = zeros(length(t), 1);
carrier = rand(size(t));                        % noise creation
waitbar(.33, f, 'Modulating');
for n = 1:length(fco)-1
    [bb, aa] = butter(3,[fco(n), fco(n+1)]/(Fs/2));
    if graphon
        figure(1)                               % GRAPH - Freq Plot
        [H, F] = freqz(bb, aa, 256, Fs);
        plot(F, abs(H), 'DisplayName', ['Band ', num2str(n)]);
        xlabel('Frequency (Hz)');
        ylabel('|H|');
        legend;
        title('Frequency Response (Bandpass)');
        hold on;
    end
    bpsignal = filter(bb, aa, signal);          % bandpass filter
    if graphon
        figure(2)                               % GRAPH - Bandpassed Signal
        plot(t, bpsignal, 'DisplayName', ['Band ', num2str(n)]);
        xlabel('Time (s)');
        ylabel('Amplitude (normalized)');
        legend
        title('Bandpassed Signals');
        hold on;
    end
    
% Envelope Rectification
    rectsignal = abs(bpsignal);                 % full-wave rectification
    [dd, cc] = butter(2, 400/(Fs/2));           % lowpass filter
    if graphon
        waitbar(.67, f, 'Graphing Intermediate Waveforms');
        figure(3)                               % GRAPH - Freq Plot
        [H, F] = freqz(dd, cc, 256, Fs);
        plot(F, abs(H), 'DisplayName', ['Band ', num2str(n)]);
        xlabel('Frequency (Hz)');
        ylabel('|H|');
        legend;
        title('Frequency Response (Lowpass)');
        hold on;
    end
    envelope = filter(dd, cc, rectsignal);
    if graphon
        figure(4)                               % GRAPH - Extracted Envelopes
        subplot(bandnum/2, 2, n)
        plot(t, envelope);
        xlabel('Time (s)');
        ylabel('Amplitude');
        title(['Envelope ', num2str(n)]);
        hold on;
    end
    
% Carrier Modulation / Summation
    if ~noiseon                                 % modulation with carrier
        carrier = sin(2*pi*round((fco(n) + fco(n+1))/2)*t);
        if graphon
            figure(5)                           % GRAPH - Modulated Signals
            subplot(bandnum/2, 2, n)
            plot(t, envelope .* carrier');
            xlabel('Time (s)');
            ylabel('Amplitude');
            title(['Mod Signal ', num2str(n)]);
            hold on;
            
        end
        y = y + (envelope .* carrier');         % summation & modulation
    else
        carriermod = envelope .* carrier';
        if graphon
            figure(5)                           % GRAPH - Modulated Signals
            subplot(bandnum/2, 2, n)
            plot(t, filter(bb, aa, carriermod));
            xlabel('Time (s)');
            ylabel('Amplitude');
            title(['Mod Signal ', num2str(n)]);
            hold on;
        end
        y = y + filter(bb, aa, carriermod);     % summation & bandpass
    end
end
y = y * (max(abs(signal))/max(abs(y)));
audiowrite(outputfile, y, Fs);

if graphon
    waitbar(.84, f, 'Graphing Final Waveforms');
    
    figure(6)                                   % GRAPH - Original/Modulated Waveforms
    subplot(211)
    plot(t, y)
    xlabel('Time (s)');
    ylabel('Amplitude (normalized)');
    title('Modulated Signal');
    subplot(212)
    plot(t, signal)
    xlabel('Time (s)');
    ylabel('Amplitude (normalized)');
    title('Original Signal');
    
    figure(7)                                   % GRAPH - Spectrograms
    subplot(211)
    [s, x, a] = spectrogram(y, hamming(512) ,32, 1024, Fs);
    surf(a, x, 20*log10(abs(s)), 'EdgeColor', 'none');
    colormap(jet); view(0,90);
    xlabel('Time (s)');
    ylabel('Frequency (Hz)');
    title('Modulated Signal Spectrogram');
    subplot(212)
    [s, x, a] = spectrogram(signal, hamming(512) ,32, 1024, Fs);
    surf(a, x, 20*log10(abs(s)), 'EdgeColor', 'none');
    colormap(jet); view(0,90);
    xlabel('Time (s)');
    ylabel('Frequency (Hz)');
    title('Original Signal Spectrogram');
end

waitbar(1, f, 'Finishing')
close(f)

if soundon
    linelength = fprintf('The Original Sound'); % SOUND - Original Sound
    sound(signal, Fs)
    pause(2)
    fprintf(repmat('\b',1,linelength))
    
    linelength = fprintf('The Modulated Sound');% SOUND - Modulated Sound
    sound(y, Fs)
    pause(2)
    fprintf(repmat('\b',1,linelength))
end
end
##### SOURCE END #####
--></body></html>